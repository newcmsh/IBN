# 적합도·예상지원금 구조 설명

이 문서는 **정책자금 스마트 매칭**에서 **적합도(점수)** 와 **예상지원금**이 어떤 구조로 계산되는지, 추천은 어떻게 이루어지는지, 그리고 **매출액이 높을수록 예상지원금이 높아지는 이유**를 정리한 것입니다.

---

## 1. 전체 흐름 요약

| 구분 | 설명 |
|------|------|
| **적합도** | 0~100 점수. **기본 점수(base)** + **가점(bonus)** − **감점(penalty)** 로 계산되며, 공고 조건 충족 여부와 인증·리스크를 반영합니다. |
| **예상지원금** | **보수 / 기준 / 최대** 3단계. 각각 **매출액 × 일정 비율**을 계산한 뒤 **공고별 최대 지원 한도**를 넘지 않도록 상한을 둡니다. |
| **추천 여부** | 결격(휴폐업·체납·연체 등)이 있으면 **즉시 탈락**, 공고 조건(업태·매출·업력·지역 등)을 만족하지 않으면 **탈락**, 모두 통과하면 **추천**으로 분류되고 점수·순위가 부여됩니다. |

구현 위치: `lib/matching/algorithm.ts` (매칭 엔진), `lib/types.ts` (타입 정의).

---

## 2. 적합도(점수) 구조

### 2.1 점수 공식

```
최종 적합도 = max(0, min(100, 기본점수(base) + 가점(bonus) − 감점(penalty)))
```

- **기본 점수(base)**: 공고의 **대상 조건**(업태, 키워드/종목, 업력, 매출, 지역)을 평가한 점수를 **70%** 반영한 값. (원점 0~100 → base = 원점 × 0.7, 최대 70점)
- **가점(bonus)**: 기업이 보유한 **인증·자격**(벤처, 이노비즈, 특허, 수출실적 등)에 따라 부여, **상한 15점**
- **감점(penalty)**: **신용/여신/보증 리스크**(과거 연체, 보증사고, 과다차입 의심 등)에 따라 부여, **상한 30점**

따라서 이론상 **최대 70 + 15 = 85점**(감점 0일 때), **최소 0점**이 됩니다. (실제로는 base가 70 미만일 수 있어 100점 미만일 수 있음. 코드상 `min(100, …)`으로 100을 넘지 않도록 처리)

### 2.2 기본 점수(base)가 나오는 방식

공고마다 **대상 조건(TargetCriteria)** 이 있습니다. 기업이 이 조건을 얼마나 만족하는지로 **0~100점**의 원점이 매겨지고, 여기에 **0.7**을 곱해 base가 됩니다.

| 평가 항목 | 배점(원점 기준) | 설명 |
|-----------|------------------|------|
| **업태 조건** | 40점 | 공고의 허용 업태(제조/도소매/서비스 등)와 기업 업태가 일치하면 만점. |
| **키워드·종목** | 최대 35점 | 공고의 포함 키워드와 기업의 종목·키워드가 일치하는 비율에 따라 배점. |
| **업력·매출·지역** | 각 약 8점 내외(합 25점) | 최소/최대 업력, 최소/최대 매출, 대상 지역 조건을 충족하면 각각 점수 부여. |

- **제외 키워드**에 하나라도 걸리면 **탈락**(점수 0).
- **업태·매출·업력·지역** 중 하나라도 조건을 만족하지 않으면 **탈락**.

즉, “조건을 만족하는 공고”에 대해서만 위 점수가 계산되고, 그 점수의 70%가 **기본 점수(base)** 로 들어갑니다.

### 2.3 가점(bonus) — 인증·자격

기업의 **인증/자격(certifications)** 이 있으면 **가점**이 붙습니다. 합계는 **최대 15점**까지입니다.

| 구분 | 인증 예시 | 가점 |
|------|-----------|------|
| +4점 | 벤처, 이노비즈, 메인비즈, 연구소 | 각 4점 (복수 보유 시 합산, 상한 15점) |
| +3점 | 특허, 수출실적 | 각 3점 |
| +2점 | 여성기업, 장애인기업, 사회적기업 | 각 2점 |
| +1점 | ISO, HACCP, GMP 등 | 각 1점 |

일부(납세·4대보험 증빙 등)는 **점수는 주지 않고**, “신청 리스크가 낮다”는 식의 **사유(reason)** 만 붙습니다.

### 2.4 감점(penalty) — 리스크

**감점요소(penalties)** 가 있으면 **감점**이 붙습니다. 합계는 **최대 30점**까지입니다.

- **Hard Fail(즉시 탈락)**: 점수 계산 없이 **추천에서 제외**
  - 휴/폐업, 회생/파산/청산, 금융 연체/채무불이행, 국세/지방세/4대보험 체납 등
- **Soft(감점만)**: 보증사고 미해소(20점), 과거 연체 해소(8점), 보증사고 해소(5점), 과다차입 의심(5점) 등

감점이 커질수록 **최종 적합도**가 낮아지고, **신뢰도(High/Medium/Low)** 구간에 영향을 줍니다.

### 2.5 신뢰도(confidence)

최종 적합도 점수에 따라 **신뢰도**가 정해집니다.

| 점수 구간 | 신뢰도 |
|-----------|--------|
| 80점 이상 | High (높음) |
| 55점 이상 ~ 80점 미만 | Medium (보통) |
| 55점 미만 | Low (낮음) |

UI에서는 “적합도 점수”와 함께 이 구간이 **높음/보통/낮음**으로 표시됩니다.

---

## 3. 추천이 어떻게 이루어지는지

### 3.1 단계별 판단

1. **1단계 — 결격(Hard Fail)**
   - 기업의 **penalties** 중 휴폐업·체납·연체·회생/파산 등 **Hard Fail**에 해당하는 항목이 하나라도 있으면 **해당 공고는 추천하지 않고 탈락**.
   - 이때는 **점수를 계산하지 않고**, 탈락 사유만 반환합니다.

2. **2단계 — 공고 조건(TargetCriteria)**
   - 업태, 제외 키워드, 업력, 매출, 지역 등 **대상 조건**을 검사.
   - 하나라도 불충족이면 **탈락** (점수 0, 탈락 사유 반환).

3. **3단계 — 통과 시**
   - 위 두 단계를 모두 통과한 공고에 대해서만 **적합도 점수**(base + bonus − penalty)를 계산하고 **추천** 목록에 넣습니다.
   - **예상지원금(3단계)** 도 이때 함께 계산됩니다.

### 3.2 추천 목록 정렬·순위

- **추천(recommended)** 에 들어간 공고는  
  - 1) **적합도 점수** 높은 순,  
  - 2) 점수 동점이면 **금리** 낮은 순(금리 없으면 맨 뒤),  
  - 3) 그 다음 **마감일** 빠른 순  
  으로 정렬됩니다.
- 이 순서대로 **rank 1, 2, 3, …** 이 부여됩니다.
- **탈락(rejected)** 공고는 별도 목록으로 모아서, 제목 등 기준으로 정렬해 모두 보여줍니다.

즉, “적합도가 높고, 금리가 낮고, 마감이 빠른 공고”가 **추천 #1**에 가깝게 노출되는 구조입니다.

---

## 4. 예상지원금 구조

### 4.1 3단계: 보수 / 기준 / 최대

예상지원금은 **한 공고당** 아래 세 가지로 나옵니다.

| 구분 | 의미 | 용도 |
|------|------|------|
| **보수(conservative)** | 보수적으로 잡은 예상 금액 | 최소한 이 정도는 기대할 수 있다는 참고치 |
| **기준(base)** | 일반적으로 사용하는 예상 금액 | 요약·총합·“예상지원금” 기본값 |
| **최대(optimistic)** | 낙관적으로 잡은 예상 금액 | 잘 나올 경우 참고치 |

UI에서는 “예상지원금 (보수 · 기준 · 최대)” 형태로, 카드별·총합 모두 이 세 값을 사용합니다.

### 4.2 지원금 산식 (어떻게 측정되는지)

**각 단계(보수/기준/최대)** 모두 아래와 같은 방식으로 계산됩니다.

```
예상지원금(단계) = min( 공고 최대 지원 한도, 매출액 × 해당 단계 비율 )
```

- **공고 최대 지원 한도**: 각 공고에 정의된 **maxAmount**(원)입니다. 이를 넘어서는 지원금은 계산하지 않습니다.
- **매출액**: 기업 프로필의 **revenue**(원)입니다.
- **해당 단계 비율**은 아래와 같습니다.

| 단계 | 비율 | 비율 상수 (코드) |
|------|------|------------------|
| 보수(conservative) | 매출의 **25%** | `REVENUE_CAP_RATIO_CONSERVATIVE = 0.25` |
| 기준(base) | 매출의 **35%** | `REVENUE_CAP_RATIO_BASE = 0.35` |
| 최대(optimistic) | 매출의 **50%** | `REVENUE_CAP_RATIO_OPTIMISTIC = 0.5` |

실제 사용 시:

- **보수** = `min(공고 한도, floor(매출 × 0.25))`
- **기준** = `min(공고 한도, floor(매출 × 0.35))`
- **최대** = `min(공고 한도, floor(매출 × 0.5))`

즉, “지원금은 **매출의 일정 비율**을 넘지 않는다”는 가정 위에, “**공고별 한도**를 넘지 않는다”는 cap을 한 번 더 거는 구조입니다.  
API·대시보드에서 말하는 **“예상지원금”**이나 **총 합산**의 기본값은 보통 이 **기준(base)** 값입니다.

---

## 5. 매출액이 높을수록 지원금이 높아지는 이유

### 5.1 상한선이 “매출 × 비율”이기 때문

정책자금·보증 등에서는 보통 **“지원 규모가 기업 규모(매출·자산 등)에 비해 지나치게 크면 안 된다”**는 원칙이 있습니다.  
이 시스템에서는 이를 **“매출의 일정 비율을 상한”**으로 두어 반영했습니다.

- **매출이 크면** → “매출 × 비율” 값이 커짐 → **min(공고 한도, 매출×비율)** 이 커질 여지가 있음 → **예상지원금이 커짐**
- **매출이 작으면** → “매출 × 비율”이 작음 → 공고 한도에 도달하기 전에 **매출 쪽에서 먼저 cap**이 걸림 → **예상지원금이 작음**

즉, **지원금 상한 = min(공고 한도, 매출×비율)** 이라서, **같은 공고**라도 **매출이 높을수록 계산된 예상지원금이 높아지는** 구조입니다.

### 5.2 예시 (숫자)

- 공고 최대 지원 한도: **3억 원**
- 보수 비율 25%, 기준 35%, 최대 50% 가정

| 매출액 | 보수(25%) | 기준(35%) | 최대(50%) |
|--------|-----------|-----------|-----------|
| 2억 | 5천만 원 | 7천만 원 | 1억 원 |
| 10억 | 2.5억 원 | 3억 원(한도 cap) | 3억 원(한도 cap) |
| 100억 | 3억 원(한도 cap) | 3억 원(한도 cap) | 3억 원(한도 cap) |

- 매출이 **2억**일 때: 세 단계 모두 “매출×비율”이 한도보다 작아서, **매출이 클수록** 세 금액이 함께 커집니다.
- 매출이 **10억·100억**처럼 크면: “매출×비율”이 3억을 넘어서, **한도(3억)** 에서 잘립니다.  
  → 그래서 “매출이 높을수록 지원금이 높아진다”는 것은 **한도에 도달하기 전 구간**에서 두드러지게 나타납니다.

### 5.3 요약

- **예상지원금** = **min(공고 한도, 매출 × 비율)** 로 측정된다.
- **매출이 높을수록** “매출 × 비율”이 커지기 때문에, 한도에 걸리기 전까지는 **예상지원금이 커진다**.
- 한도에 걸리면 그 이상은 늘지 않고, **공고별 최대 지원 한도**가 최대치가 된다.

---

## 6. 데이터 구조 참고 (타입)

- **적합도·점수 구성**: `MatchResult.score`, `MatchResult.scoreBreakdown` (base, bonus, penalty, final), `MatchResult.confidence`
- **예상지원금**: `MatchResult.expectedAmount`(기준값), `MatchResult.amountRange` (conservative, base, optimistic)
- **추천/탈락**: `MatchResult.passed`, `MatchResult.reasons`, `MatchResult.rejectReasons`, `MatchResult.flags` (hardFail, hardFailReasons, warnings)

자세한 필드는 `lib/types.ts`의 `MatchResult`, `AmountRange`, `CompanyProfile`, `GrantAnnouncement`를 참고하면 됩니다.

---

## 7. 관련 파일

| 파일 | 역할 |
|------|------|
| `lib/matching/algorithm.ts` | 적합도 계산(base/bonus/penalty), 예상지원금 3단계(calcAmountRange), 추천/탈락 분리 및 정렬(runFullMatching) |
| `lib/types.ts` | CompanyProfile, GrantAnnouncement, TargetCriteria, MatchResult, AmountRange 타입 정의 |
| `app/api/match/route.ts` | 매칭 API: 기업 정보·공고 목록 받아 위 알고리즘 호출 후 recommended/rejected·totalExpectedAmount 반환 |
| `components/MatchingCard.tsx` | 카드별 적합도·신뢰도·점수 구성·예상지원금(보수·기준·최대) 표시 |
| `components/Dashboard.tsx` | 총 합산 지원금(기준 등)·추천/탈락 건수·bestMatch 표시 |

이 문서는 위 코드와 타입 정의를 기준으로 작성되었습니다.
